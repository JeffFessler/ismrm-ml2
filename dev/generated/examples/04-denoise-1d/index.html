<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>04-denoise-1d · ismrm_ml2</title><meta name="title" content="04-denoise-1d · ismrm_ml2"/><meta property="og:title" content="04-denoise-1d · ismrm_ml2"/><meta property="twitter:title" content="04-denoise-1d · ismrm_ml2"/><meta name="description" content="Documentation for ismrm_ml2."/><meta property="og:description" content="Documentation for ismrm_ml2."/><meta property="twitter:description" content="Documentation for ismrm_ml2."/><meta property="og:url" content="https://JeffFessler.github.io/ismrm_ml2.jl/stable/generated/examples/04-denoise-1d/"/><meta property="twitter:url" content="https://JeffFessler.github.io/ismrm_ml2.jl/stable/generated/examples/04-denoise-1d/"/><link rel="canonical" href="https://JeffFessler.github.io/ismrm_ml2.jl/stable/generated/examples/04-denoise-1d/"/><script data-outdated-warner src="../../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../assets/documenter.js"></script><script src="../../../search_index.js"></script><script src="../../../siteinfo.js"></script><script src="../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../assets/themeswap.js"></script><link href="../../../assets/custom.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../../">ismrm_ml2</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../../">Home</a></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../01-overview/">01-overview</a></li><li><a class="tocitem" href="../02-digits/">02-digits</a></li><li><a class="tocitem" href="../03-flux-ring2/">03-flux-ring2</a></li><li class="is-active"><a class="tocitem" href>04-denoise-1d</a><ul class="internal"><li><a class="tocitem" href="#Basic-Introduction-to-Machine-Learning:-04-denoise-1d"><span>Basic Introduction to Machine Learning: 04-denoise-1d</span></a></li><li><a class="tocitem" href="#Training-data"><span>Training data</span></a></li><li><a class="tocitem" href="#Simple-NN"><span>Simple NN</span></a></li><li><a class="tocitem" href="#Examine-a-single-hidden-layer-NN"><span>Examine a single hidden layer NN</span></a></li><li class="toplevel"><a class="tocitem" href="#Create-a-basic-NN-model"><span>Create a basic NN model</span></a></li><li><a class="tocitem" href="#WIP"><span>WIP</span></a></li></ul></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>04-denoise-1d</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>04-denoise-1d</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/JeffFessler/ismrm_ml2" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/JeffFessler/ismrm_ml2/blob/main/docs/lit/examples/04-denoise-1d.jl" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="04-denoise-1d"><a class="docs-heading-anchor" href="#04-denoise-1d">04-denoise-1d</a><a id="04-denoise-1d-1"></a><a class="docs-heading-anchor-permalink" href="#04-denoise-1d" title="Permalink"></a></h1><h2 id="Basic-Introduction-to-Machine-Learning:-04-denoise-1d"><a class="docs-heading-anchor" href="#Basic-Introduction-to-Machine-Learning:-04-denoise-1d">Basic Introduction to Machine Learning: 04-denoise-1d</a><a id="Basic-Introduction-to-Machine-Learning:-04-denoise-1d-1"></a><a class="docs-heading-anchor-permalink" href="#Basic-Introduction-to-Machine-Learning:-04-denoise-1d" title="Permalink"></a></h2><p>Illustrate 1D signal denoising using Julia&#39;s Flux library</p><ul><li>Jeff Fessler, University of Michigan</li><li>2018-10-23 Julia 1.0.1 version</li><li>2023-01-29 Julia 1.8.5 version</li></ul><p>This page was generated from a single Julia file: <a href="https://github.com/JeffFessler/ismrm_ml2/blob/main/docs/lit/examples/04-denoise-1d.jl">04-denoise-1d.jl</a>.</p><p>In any such Julia documentation, you can access the source code using the &quot;Edit on GitHub&quot; link in the top right.</p><p>The corresponding notebook can be viewed in <a href="https://nbviewer.org/">nbviewer</a> here: <a href="https://nbviewer.org/github/JeffFessler/ismrm_ml2/tree/gh-pages/dev/generated/examples/04-denoise-1d.ipynb"><code>04-denoise-1d.ipynb</code></a>, and opened in <a href="https://mybinder.org/">binder</a> here: <a href="https://mybinder.org/v2/gh/JeffFessler/ismrm_ml2/gh-pages?filepath=dev/generated/examples/04-denoise-1d.ipynb"><code>04-denoise-1d.ipynb</code></a>.</p><h3 id="Setup"><a class="docs-heading-anchor" href="#Setup">Setup</a><a id="Setup-1"></a><a class="docs-heading-anchor-permalink" href="#Setup" title="Permalink"></a></h3><p>Packages needed here.</p><pre><code class="language-julia hljs">using LinearAlgebra: norm, I
using Random: seed!
using Distributions: Normal, randperm
import Flux # Julia package for deep learning
using Flux: Dense, Conv, Chain, SkipConnection, Adam, mse, relu, SamePad
using LaTeXStrings # pretty plot labels
using Plots: plot, plot!, scatter, scatter!, histogram, histogram2d, default, font, gui
using MIRTjim: jim, prompt
using InteractiveUtils: versioninfo

default(markersize=5, markerstrokecolor=:auto, label=&quot;&quot;)
default(tickfontsize=10, legendfontsize=11)</code></pre><p>The following line is helpful when running this file as a script; this way it will prompt user to hit a key after each figure is displayed.</p><pre><code class="language-julia hljs">isinteractive() ? jim(:prompt, true) : prompt(:draw);</code></pre><h2 id="Training-data"><a class="docs-heading-anchor" href="#Training-data">Training data</a><a id="Training-data-1"></a><a class="docs-heading-anchor-permalink" href="#Training-data" title="Permalink"></a></h2><p>Generate training and testing data; 1D piece-wise constant signals</p><p>Function to generate a random piece-wise constant signal</p><pre><code class="language-julia hljs">function makestep(; dim=32, njump=3, valueDist=Normal(0, 1), minsep=2)
    jump_locations = randperm(dim)[1:njump]
    while minimum(diff(jump_locations)) &lt;= minsep
        jump_locations = randperm(dim)[1:njump] # random jump locations
    end
    index = zeros(dim)
    index[jump_locations] .= 1
    index = cumsum(index)
    values = rand(valueDist, njump) # random signal values
    x = zeros(Float32, dim)
    for jj in 1:njump
        x[index .== jj] .= values[jj]
    end
    x[index .== 0] .= values[njump] # periodic end conditions
    x = circshift(x, rand(1:dim, 1)) # random shift - just to be sure
    return x
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">makestep (generic function with 1 method)</code></pre><p>Training data</p><pre><code class="language-julia hljs">seed!(0)
siz = 32

ntrain = 2^11
Xtrain = [makestep(dim=siz) for _ in 1:ntrain] # noiseless data
Xtrain = hcat(Xtrain...) # (siz, ntrain)

ntest = 2^10
Xtest = [makestep(dim=siz) for _ in 1:ntest] # noiseless data
Xtest = hcat(Xtest...) # (siz, ntest)

p0 = plot(Xtrain[:,1:14], label=&quot;&quot;)</code></pre><img src="cdd2fc69.svg" alt="Example block output"/><pre><code class="language-julia hljs">prompt()</code></pre><p>Data covariance</p><pre><code class="language-julia hljs">Kx = Xtrain * Xtrain&#39; / ntrain
p1 = jim(Kx, title=&quot;Kx&quot;, color=:cividis);</code></pre><p>Add noise</p><pre><code class="language-julia hljs">σnoise = 0.3
Ytrain = Xtrain + σnoise * randn(Float32, size(Xtrain)) # noisy train data
Ytest = Xtest + σnoise * randn(Float32, size(Xtest)) # noisy test data
Ky = Ytrain * Ytrain&#39; / ntrain;

@show maximum(Kx)
@show maximum(Ky)

p2 = jim(Ky, title=&quot;Ky&quot;, color=:cividis)
plot(p0, p1, p2, layout=(3,1))</code></pre><img src="72c17e9c.svg" alt="Example block output"/><pre><code class="language-julia hljs">prompt()</code></pre><p>Wiener filter (MMSE estimator)</p><pre><code class="language-julia hljs"># cond(Kx + σnoise*I)
Hw = Kx * inv(Kx + σnoise^2 * I)
jim(Hw; title=&quot;Wiener filter&quot;, color=:cividis)</code></pre><img src="d7ffe018.svg" alt="Example block output"/><p>Denoise via Wiener filter (MMSE <em>linear</em> method)</p><pre><code class="language-julia hljs">Xw = Hw * Ytest
nrmse = (Xh) -&gt; round(norm(Xh - Xtest) / norm(Xtest) * 100, digits=2)
@show nrmse(Ytest), nrmse(Xw)
colors = [:blue, :red, :magenta, :green]
plot(ylabel=&quot;signal value&quot;, title=&quot;Wiener filtering examples&quot;)
for i in 1:4
    plot!(Xw[:,i], color=colors[i])
    plot!(Xtest[:,i], color=colors[i], line=:dash)
    scatter!(Ytest[:,i], color=colors[i], marker=:star)
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">(nrmse(Ytest), nrmse(Xw)) = (30.64, 23.38)</code></pre><pre><code class="language-julia hljs">prompt()</code></pre><p>Verify that marginal distribution is Gaussian</p><pre><code class="language-julia hljs">histogram(Xtrain[:], label = &quot;Xtrain hist&quot;)</code></pre><img src="90dc458e.svg" alt="Example block output"/><pre><code class="language-julia hljs">prompt()</code></pre><h2 id="Simple-NN"><a class="docs-heading-anchor" href="#Simple-NN">Simple NN</a><a id="Simple-NN-1"></a><a class="docs-heading-anchor-permalink" href="#Simple-NN" title="Permalink"></a></h2><p>Examine a &quot;NN&quot; that is a single fully connected affine layer (It should perform same as Wiener filter.)</p><p>First try a basic affine NN model</p><pre><code class="language-julia hljs">if !@isdefined(state1)
    model1 = Chain(Dense(siz,siz))
    loss3(model, x, y) = mse(model(x), y)

    iters = 2^12
    dataset = Base.Iterators.repeated((Ytrain, Xtrain), iters) # trick X,Y swap for denoising!

    state1 = Flux.setup(Adam(), model1)
    Flux.train!(loss3, model1, dataset, state1)
end;</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">┌ Warning: Layer with Float32 parameters got Float64 input.
│   The input will be converted, but any earlier layers may be very slow.
│   layer = Dense(32 =&gt; 32)     # 1_056 parameters
│   summary(x) = &quot;32×2048 Matrix{Float64}&quot;
└ @ Flux ~/.julia/packages/Flux/UsEXa/src/layers/stateless.jl:60</code></pre><p>Compare training affine NN to wiener filter</p><pre><code class="language-julia hljs">H1 = model1(Matrix(I, siz, siz))
jim(H1; title=&quot;Learned filter for affine NN&quot;, colormap=:cividis)</code></pre><img src="403a77bc.svg" alt="Example block output"/><p>Denoise test Data</p><pre><code class="language-julia hljs">X1 = H1 * Ytest
X1nn = model1(Ytest)
@show nrmse(Ytest), nrmse(Xw), nrmse(X1), nrmse(X1nn)
bias = model1(zeros(siz))
@show extrema(bias)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">(-0.008014476f0, 0.007329959f0)</code></pre><h2 id="Examine-a-single-hidden-layer-NN"><a class="docs-heading-anchor" href="#Examine-a-single-hidden-layer-NN">Examine a single hidden layer NN</a><a id="Examine-a-single-hidden-layer-NN-1"></a><a class="docs-heading-anchor-permalink" href="#Examine-a-single-hidden-layer-NN" title="Permalink"></a></h2><h1 id="Create-a-basic-NN-model"><a class="docs-heading-anchor" href="#Create-a-basic-NN-model">Create a basic NN model</a><a id="Create-a-basic-NN-model-1"></a><a class="docs-heading-anchor-permalink" href="#Create-a-basic-NN-model" title="Permalink"></a></h1><pre><code class="language-julia hljs">if !@isdefined(state2)
    nhidden = 2siz # neurons in hidden layer
    model2 = Chain(Dense(siz, nhidden, relu), Dense(nhidden, siz))

    iters = 2^12
    dataset = Base.Iterators.repeated((Ytrain, Xtrain), iters) # trick X,Y swap for denoising!

    state2 = Flux.setup(Adam(), model2)
    Flux.train!(loss3, model2, dataset, state2)
    X2 = model2(Ytest)
end
tmp = [Ytest, Xw, X1, X1nn, X2]
@show nrmse.(tmp)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">5-element Vector{Float64}:
 30.64
 23.38
 25.43
 23.53
 24.29</code></pre><p>Examine joint distribution</p><pre><code class="language-julia hljs">lag = 1
tmp = circshift(Xtrain, (lag,))
histogram2d(vec(Xtrain), vec(tmp))
plot!(aspect_ratio=1, xlim=[-4,4], ylim=[-4,4])
plot!(xlabel=L&quot;x[n]&quot;, ylabel=latexstring(&quot;x[n-$lag \\ mod \\ N]&quot;))
plot!(title=&quot;Joint histogram of neighbors&quot;)</code></pre><img src="018fce3e.svg" alt="Example block output"/><pre><code class="language-julia hljs">prompt()</code></pre><h2 id="WIP"><a class="docs-heading-anchor" href="#WIP">WIP</a><a id="WIP-1"></a><a class="docs-heading-anchor-permalink" href="#WIP" title="Permalink"></a></h2><p>Experiments below here - work in progress [https://github.com/FluxML/model-zoo/blob/master/vision/mnist/conv.jl]</p><pre><code class="language-julia hljs">if !@isdefined(model3)

    model3 = SkipConnection( # ResNet style: learn residual
        Chain(
            Conv((3,), 1 =&gt; 16, relu; pad = SamePad()),
        #  x -&gt; maxpool(x, (2,2)),
            Conv((3,), 16 =&gt; 8, relu; pad = SamePad()),
            Conv((1,), 8 =&gt; 1, relu),
        #  x -&gt; reshape(x, :, size(x, 4)),
        ),
        +,
    )

    shaper(X) = reshape(X, siz, 1, :) # (siz, channels, batch)
    mymodel3(X) = model3(shaper(X))[:, 1, :]
    @assert size(mymodel3(Xtrain)) == size(Xtrain)

    nouter = 2^2
    ninner = 2^3
    # trick X,Y swap for denoising!
    dataset = Base.Iterators.repeated((shaper(Ytrain), shaper(Xtrain)), ninner)
    for io in 1:nouter
        state3 = Flux.setup(Adam(), model3)
        Flux.train!(loss3, model3, dataset, state3)
        X3train = mymodel3(Ytrain)
        @show io, loss3(model3, shaper(Xtrain), shaper(Ytrain))
        # todo: validation data too
    end
end


X3test = mymodel3(Ytest)
tmp = [Ytest, Xw, X1, X1nn, X2, X3test]
@show nrmse.(tmp) # todo: no improvement!?</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">6-element Vector{Float64}:
 30.64
 23.38
 25.43
 23.53
 24.29
 28.08</code></pre><h3 id="Reproducibility"><a class="docs-heading-anchor" href="#Reproducibility">Reproducibility</a><a id="Reproducibility-1"></a><a class="docs-heading-anchor-permalink" href="#Reproducibility" title="Permalink"></a></h3><p>This page was generated with the following version of Julia:</p><pre><code class="language-julia hljs">io = IOBuffer(); versioninfo(io); split(String(take!(io)), &#39;\n&#39;)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">12-element Vector{SubString{String}}:
 &quot;Julia Version 1.10.0&quot;
 &quot;Commit 3120989f39b (2023-12-25 18:01 UTC)&quot;
 &quot;Build Info:&quot;
 &quot;  Official https://julialang.org/ release&quot;
 &quot;Platform Info:&quot;
 &quot;  OS: Linux (x86_64-linux-gnu)&quot;
 &quot;  CPU: 4 × AMD EPYC 7763 64-Core Processor&quot;
 &quot;  WORD_SIZE: 64&quot;
 &quot;  LIBM: libopenlibm&quot;
 &quot;  LLVM: libLLVM-15.0.7 (ORCJIT, znver3)&quot;
 &quot;  Threads: 1 on 4 virtual cores&quot;
 &quot;&quot;</code></pre><p>And with the following package versions</p><pre><code class="language-julia hljs">import Pkg; Pkg.status()</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Status `~/work/ismrm_ml2/ismrm_ml2/docs/Project.toml`
  [31c24e10] Distributions v0.25.107
  [e30172f5] Documenter v1.2.1
  [587475ba] Flux v0.14.9
  [b964fa9f] LaTeXStrings v1.3.1
  [98b081ad] Literate v2.16.1
  [170b2178] MIRTjim v0.23.0
  [eb30cadb] MLDatasets v0.7.14
  [91a5bcdd] Plots v1.39.0
  [2913bbd2] StatsBase v0.34.2
  [1986cc42] Unitful v1.19.0
  [ef84fa70] ismrm_ml2 v0.0.1 `~/work/ismrm_ml2/ismrm_ml2`
  [b77e0a4c] InteractiveUtils
  [37e2e46d] LinearAlgebra
  [9a3f8284] Random</code></pre><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../03-flux-ring2/">« 03-flux-ring2</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.2.1 on <span class="colophon-date" title="Monday 22 January 2024 02:00">Monday 22 January 2024</span>. Using Julia version 1.10.0.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
